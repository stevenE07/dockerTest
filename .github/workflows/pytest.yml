name: Django Tests

on:
  push:
    branches:
      - prueba  # Cambia esto al nombre de tu rama principal si es diferente

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v2

      - name: Configurar Docker
        uses: actions/setup-python@v2
        with:
          python-version: 3.x

      - name: Iniciar contenedor de Docker
        run: docker-compose up --build -d

      - name: Esperar a que el servicio Django esté disponible
        run: |
          while ! curl -s http://localhost:8000; do
            sleep 5
          done

      - name: Ejecutar pruebas con pytest y redirigir la salida a un archivo en el contenedor
        run: docker-compose exec -it web sh -c "pytest -ra > .test_output.txt"
             sleep 5
      - name: Copiar archivo de salida del contenedor al host
        run: docker cp web:./test_output.txt ./test_output.txt

      - name: Subir el archivo de salida de las pruebas como un artefacto
        uses: actions/upload-artifact@v2
        with:
          name: test-output
          path: test_output.txt